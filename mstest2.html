<!DOCTYPE html>
<html>
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no"/>
 <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
 <h1>Media Capture and Stream API</h1>
 <div>
  <button onclick="start()" id="start">開始</button>
  <button onclick="end()" id="end" disabled>終了</button>
 </div>
 <div><div id="graph"></div></div>
 <script type="text/javascript"><!--
navigator.mediaDevices = navigator.mediaDevices || ((navigator.mozGetUserMedia || navigator.webkitGetUserMedia) ? {
   getUserMedia: function(c) {
     return new Promise(function(y, n) {
       (navigator.mozGetUserMedia ||
        navigator.webkitGetUserMedia).call(navigator, c, y, n);
     });
   }
} : null);

var AudioContext = window.AudioContext || window.webkitAudioContext;
var audioCtx = new AudioContext();
navigator.mediaDevices.getUserMedia({audio: true}).then(function(stream) {
  // ノードの準備
  var source = audioCtx.createMediaStreamSource(stream);
  var scriptNode = audioCtx.createScriptProcessor(4096, 1, 1);
  scriptNode.onaudioprocess = function (e) {
    var input = e.inputBuffer.getChannelData(0); // 生の音声データ
    // inputを使っていろいろやる
    // 入力をそのまま出力する
    var output = e.outputBuffer.getChannelData(0);
    for (var i=0;i<input.length;i++) {
      output[i] = input[i];
    }
  };
  // それぞれのノードを接続
  source.connect(scriptNode);
  scriptNode.connect(audioCtx.destination);
}).catch(function(e) { alert("開始できません(" + e + ")。"); } );
 --></script>
</body>
</html>
